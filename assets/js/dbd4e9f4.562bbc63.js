"use strict";(globalThis.webpackChunkace_wiki=globalThis.webpackChunkace_wiki||[]).push([[505],{4658:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"tutorials/containers/containers-hpc","title":"Containers on High Performance Compute Clusters","description":"This tutorial covers running containerized workloads on ACE HPC. You\'ll learn how to use Apptainer to pull and run containers, write SLURM job scripts, manage data with bind mounts, and optimize performance on the cluster.","source":"@site/docs/tutorials/containers/containers-hpc.md","sourceDirName":"tutorials/containers","slug":"/tutorials/containers/containers-hpc","permalink":"/ace-ug-hpc-wiki/docs/tutorials/containers/containers-hpc","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorials/containers/containers-hpc.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"id":"containers-hpc","title":"Containers on High Performance Compute Clusters","sidebar_label":"Containers on HPC","sidebar_position":4},"sidebar":"wikiSidebar","previous":{"title":"Containerize Your Code","permalink":"/ace-ug-hpc-wiki/docs/tutorials/containers/containerize-code"},"next":{"title":"Advanced Build Topics","permalink":"/ace-ug-hpc-wiki/docs/tutorials/containers/advanced-builds"}}');var s=i(4848),t=i(8453);const r={id:"containers-hpc",title:"Containers on High Performance Compute Clusters",sidebar_label:"Containers on HPC",sidebar_position:4},o="Containers on High Performance Compute Clusters",c={},l=[{value:"Learning Objectives",id:"learning-objectives",level:2},{value:"Getting Started with Apptainer",id:"getting-started-with-apptainer",level:2},{value:"Loading the Apptainer Module",id:"loading-the-apptainer-module",level:3},{value:"Pulling Container Images",id:"pulling-container-images",level:3},{value:"Pull Options",id:"pull-options",level:3},{value:"Managing the Cache",id:"managing-the-cache",level:3},{value:"Exercise 1: Pull Your First Image",id:"exercise-1-pull-your-first-image",level:2},{value:"Running Containers",id:"running-containers",level:2},{value:"Three Ways to Run",id:"three-ways-to-run",level:3},{value:"Using <code>exec</code> (Most Common)",id:"using-exec-most-common",level:3},{value:"Using <code>shell</code> (Interactive)",id:"using-shell-interactive",level:3},{value:"Using <code>run</code> (Default Action)",id:"using-run-default-action",level:3},{value:"Exercise 2: Run Commands in Containers",id:"exercise-2-run-commands-in-containers",level:2},{value:"Understanding Bind Mounts",id:"understanding-bind-mounts",level:2},{value:"Verifying Default Binds",id:"verifying-default-binds",level:3},{value:"Custom Bind Mounts",id:"custom-bind-mounts",level:3},{value:"SLURM Job Scripts for Containers",id:"slurm-job-scripts-for-containers",level:2},{value:"Basic Container Job",id:"basic-container-job",level:3},{value:"Job with Data Binding",id:"job-with-data-binding",level:3},{value:"Exercise 3: Submit a Container Job",id:"exercise-3-submit-a-container-job",level:2},{value:"GPU Jobs with Containers",id:"gpu-jobs-with-containers",level:2},{value:"Enabling GPU Access",id:"enabling-gpu-access",level:3},{value:"GPU SLURM Job",id:"gpu-slurm-job",level:3},{value:"Multi-GPU Job",id:"multi-gpu-job",level:3},{value:"Exercise 4: GPU Container Job",id:"exercise-4-gpu-container-job",level:2},{value:"MPI Jobs with Containers",id:"mpi-jobs-with-containers",level:2},{value:"Running MPI Containers",id:"running-mpi-containers",level:3},{value:"Hybrid MPI + OpenMP",id:"hybrid-mpi--openmp",level:3},{value:"Array Jobs",id:"array-jobs",level:2},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Passing Variables to Containers",id:"passing-variables-to-containers",level:3},{value:"SLURM Variables in Containers",id:"slurm-variables-in-containers",level:3},{value:"Clean Environment",id:"clean-environment",level:3},{value:"Performance Optimization",id:"performance-optimization",level:2},{value:"Use Local Scratch for I/O",id:"use-local-scratch-for-io",level:3},{value:"Store Containers on Fast Storage",id:"store-containers-on-fast-storage",level:3},{value:"Avoid Unnecessary Bind Mounts",id:"avoid-unnecessary-bind-mounts",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues and Solutions",id:"common-issues-and-solutions",level:3},{value:"Job Script Templates",id:"job-script-templates",level:2},{value:"Template: Standard CPU Job",id:"template-standard-cpu-job",level:3},{value:"Template: GPU Deep Learning",id:"template-gpu-deep-learning",level:3},{value:"Template: Bioinformatics Pipeline",id:"template-bioinformatics-pipeline",level:3},{value:"Quick Reference",id:"quick-reference",level:2},{value:"Essential Commands",id:"essential-commands",level:3},{value:"Common Flags",id:"common-flags",level:3},{value:"Summary",id:"summary",level:2},{value:"Additional Resources",id:"additional-resources",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"containers-on-high-performance-compute-clusters",children:"Containers on High Performance Compute Clusters"})}),"\n",(0,s.jsx)(e.p,{children:"This tutorial covers running containerized workloads on ACE HPC. You'll learn how to use Apptainer to pull and run containers, write SLURM job scripts, manage data with bind mounts, and optimize performance on the cluster."}),"\n",(0,s.jsx)(e.h2,{id:"learning-objectives",children:"Learning Objectives"}),"\n",(0,s.jsx)(e.p,{children:"After completing this tutorial, you will be able to:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Use Apptainer to pull and convert Docker images"}),"\n",(0,s.jsx)(e.li,{children:"Execute commands inside containers on ACE HPC"}),"\n",(0,s.jsx)(e.li,{children:"Write SLURM job scripts for containerized workflows"}),"\n",(0,s.jsx)(e.li,{children:"Manage input/output data with bind mounts"}),"\n",(0,s.jsx)(e.li,{children:"Run GPU and MPI jobs using containers"}),"\n",(0,s.jsx)(e.li,{children:"Troubleshoot common container issues on HPC"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"getting-started-with-apptainer",children:"Getting Started with Apptainer"}),"\n",(0,s.jsx)(e.h3,{id:"loading-the-apptainer-module",children:"Loading the Apptainer Module"}),"\n",(0,s.jsx)(e.p,{children:"On ACE HPC, Apptainer is available as a module:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Load the Apptainer module\nmodule load apptainer\n\n# Verify installation\napptainer --version\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Expected output:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"apptainer version 1.2.x\n"})}),"\n",(0,s.jsx)(e.h3,{id:"pulling-container-images",children:"Pulling Container Images"}),"\n",(0,s.jsx)(e.p,{children:"Apptainer can pull images from Docker Hub and other registries:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Pull from Docker Hub\napptainer pull docker://python:3.11-slim\n\n# This creates: python_3.11-slim.sif\n"})}),"\n",(0,s.jsxs)(e.p,{children:["The ",(0,s.jsx)(e.code,{children:".sif"})," (Singularity Image Format) file is Apptainer's native format - a single, portable file containing the entire container."]}),"\n",(0,s.jsx)(e.h3,{id:"pull-options",children:"Pull Options"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Specify output filename\napptainer pull python.sif docker://python:3.11-slim\n\n# Pull to a specific directory\napptainer pull ~/containers/pytorch.sif docker://pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime\n\n# Force re-download (ignore cache)\napptainer pull --force python.sif docker://python:3.11-slim\n"})}),"\n",(0,s.jsx)(e.h3,{id:"managing-the-cache",children:"Managing the Cache"}),"\n",(0,s.jsx)(e.p,{children:"Apptainer caches downloaded layers:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# View cache location and size\napptainer cache list\n\n# Clean the cache (free disk space)\napptainer cache clean\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"exercise-1-pull-your-first-image",children:"Exercise 1: Pull Your First Image"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Create a container directory\nmkdir -p ~/containers\ncd ~/containers\n\n# Load Apptainer\nmodule load apptainer\n\n# Pull Python image\napptainer pull docker://python:3.11-slim\n\n# Verify\nls -lh python_3.11-slim.sif\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"running-containers",children:"Running Containers"}),"\n",(0,s.jsx)(e.h3,{id:"three-ways-to-run",children:"Three Ways to Run"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Command"}),(0,s.jsx)(e.th,{children:"Purpose"}),(0,s.jsx)(e.th,{children:"Example"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"apptainer exec"})}),(0,s.jsx)(e.td,{children:"Run a specific command"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"apptainer exec python.sif python script.py"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"apptainer run"})}),(0,s.jsx)(e.td,{children:"Run the default command"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"apptainer run python.sif"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"apptainer shell"})}),(0,s.jsx)(e.td,{children:"Interactive shell"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"apptainer shell python.sif"})})]})]})]}),"\n",(0,s.jsxs)(e.h3,{id:"using-exec-most-common",children:["Using ",(0,s.jsx)(e.code,{children:"exec"})," (Most Common)"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Run a Python command\napptainer exec python_3.11-slim.sif python --version\n\n# Run a Python script\napptainer exec python_3.11-slim.sif python analysis.py\n\n# Run with arguments\napptainer exec python_3.11-slim.sif python train.py --epochs 100 --batch-size 32\n"})}),"\n",(0,s.jsxs)(e.h3,{id:"using-shell-interactive",children:["Using ",(0,s.jsx)(e.code,{children:"shell"})," (Interactive)"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Start interactive shell\napptainer shell python_3.11-slim.sif\n\n# You'll see a new prompt:\nApptainer> python --version\nApptainer> pip list\nApptainer> exit\n"})}),"\n",(0,s.jsxs)(e.h3,{id:"using-run-default-action",children:["Using ",(0,s.jsx)(e.code,{children:"run"})," (Default Action)"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Run the container's default command\napptainer run python_3.11-slim.sif\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"exercise-2-run-commands-in-containers",children:"Exercise 2: Run Commands in Containers"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"cd ~/containers\n\n# Execute a Python one-liner\napptainer exec python_3.11-slim.sif python -c \"\nimport sys\nprint(f'Python version: {sys.version}')\nprint(f'Executable: {sys.executable}')\n\"\n\n# Check what packages are available\napptainer exec python_3.11-slim.sif pip list\n\n# Start an interactive session\napptainer shell python_3.11-slim.sif\n# Try: python, pip list, cat /etc/os-release, exit\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"understanding-bind-mounts",children:"Understanding Bind Mounts"}),"\n",(0,s.jsx)(e.p,{children:"By default, Apptainer automatically binds (mounts) several directories:"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Host Directory"}),(0,s.jsx)(e.th,{children:"Container Path"}),(0,s.jsx)(e.th,{children:"Access"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"$HOME"})}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"$HOME"})}),(0,s.jsx)(e.td,{children:"Read/Write"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"$PWD"})}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"$PWD"})}),(0,s.jsx)(e.td,{children:"Read/Write"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"/tmp"})}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"/tmp"})}),(0,s.jsx)(e.td,{children:"Read/Write"})]})]})]}),"\n",(0,s.jsx)(e.p,{children:"This means your home directory and current working directory are accessible inside the container."}),"\n",(0,s.jsx)(e.h3,{id:"verifying-default-binds",children:"Verifying Default Binds"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Check what you can access\napptainer exec python_3.11-slim.sif ls ~\n\n# Your current directory is available\necho "Hello from host" > test.txt\napptainer exec python_3.11-slim.sif cat test.txt\n'})}),"\n",(0,s.jsx)(e.h3,{id:"custom-bind-mounts",children:"Custom Bind Mounts"}),"\n",(0,s.jsxs)(e.p,{children:["Use ",(0,s.jsx)(e.code,{children:"--bind"})," or ",(0,s.jsx)(e.code,{children:"-B"})," to mount additional directories:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Mount a data directory\napptainer exec --bind /data/shared:/data python_3.11-slim.sif ls /data\n\n# Mount read-only\napptainer exec --bind /data/shared:/data:ro python_3.11-slim.sif ls /data\n\n# Mount multiple directories\napptainer exec \\\n    --bind /data/input:/input:ro \\\n    --bind /scratch/$USER:/output \\\n    python_3.11-slim.sif python process.py\n\n# Mount with different path inside container\napptainer exec --bind /data/project/raw_reads:/reads python_3.11-slim.sif ls /reads\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"slurm-job-scripts-for-containers",children:"SLURM Job Scripts for Containers"}),"\n",(0,s.jsx)(e.h3,{id:"basic-container-job",children:"Basic Container Job"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=container-job\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=01:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=4\n#SBATCH --mem=8G\n\n# Load Apptainer\nmodule load apptainer\n\n# Define paths\nCONTAINER=~/containers/python_3.11-slim.sif\nSCRIPT=~/project/analysis.py\n\n# Run the container\napptainer exec $CONTAINER python $SCRIPT\n"})}),"\n",(0,s.jsx)(e.h3,{id:"job-with-data-binding",children:"Job with Data Binding"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=data-analysis\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=04:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=8\n#SBATCH --mem=32G\n\nmodule load apptainer\n\n# Paths\nCONTAINER=~/containers/datascience.sif\nINPUT_DIR=/data/shared/project/raw_data\nOUTPUT_DIR=/scratch/$USER/results_$SLURM_JOB_ID\n\n# Create output directory\nmkdir -p $OUTPUT_DIR\n\n# Run with bind mounts\napptainer exec \\\n    --bind $INPUT_DIR:/input:ro \\\n    --bind $OUTPUT_DIR:/output \\\n    $CONTAINER python /app/analyze.py \\\n        --input /input \\\n        --output /output\n\n# Copy results to permanent storage\ncp -r $OUTPUT_DIR /data/shared/project/results/\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"exercise-3-submit-a-container-job",children:"Exercise 3: Submit a Container Job"}),"\n",(0,s.jsx)(e.p,{children:"Create a complete job workflow:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"mkdir -p ~/container-job\ncd ~/container-job\n"})}),"\n",(0,s.jsx)(e.p,{children:"Create a Python script:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"cat > process.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"Sample processing script.\"\"\"\n\nimport os\nimport json\nfrom datetime import datetime\n\ndef main():\n    output_dir = os.environ.get('OUTPUT_DIR', '/output')\n    job_id = os.environ.get('SLURM_JOB_ID', 'local')\n\n    print(f\"Job ID: {job_id}\")\n    print(f\"Output directory: {output_dir}\")\n    print(f\"Processing started at: {datetime.now()}\")\n\n    # Simulate some work\n    results = {\n        'job_id': job_id,\n        'timestamp': datetime.now().isoformat(),\n        'status': 'completed',\n        'data': list(range(10))\n    }\n\n    # Save results\n    output_file = os.path.join(output_dir, f'results_{job_id}.json')\n    with open(output_file, 'w') as f:\n        json.dump(results, f, indent=2)\n\n    print(f\"Results saved to: {output_file}\")\n    print(f\"Processing completed at: {datetime.now()}\")\n\nif __name__ == \"__main__\":\n    main()\nEOF\n"})}),"\n",(0,s.jsx)(e.p,{children:"Create the job script:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"cat > job.sh << 'EOF'\n#!/bin/bash\n#SBATCH --job-name=container-test\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=00:10:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --mem=2G\n\nmodule load apptainer\n\n# Setup\nWORK_DIR=~/container-job\nOUTPUT_DIR=$WORK_DIR/output_$SLURM_JOB_ID\nmkdir -p $OUTPUT_DIR\n\n# Run container\napptainer exec \\\n    --env OUTPUT_DIR=$OUTPUT_DIR \\\n    ~/containers/python_3.11-slim.sif \\\n    python $WORK_DIR/process.py\n\n# Show results\necho \"Output files:\"\nls -la $OUTPUT_DIR/\nEOF\n"})}),"\n",(0,s.jsx)(e.p,{children:"Submit and monitor:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"sbatch job.sh\nsqueue -u $USER\n# After completion:\ncat container-test_*.out\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"gpu-jobs-with-containers",children:"GPU Jobs with Containers"}),"\n",(0,s.jsx)(e.h3,{id:"enabling-gpu-access",children:"Enabling GPU Access"}),"\n",(0,s.jsxs)(e.p,{children:["Use the ",(0,s.jsx)(e.code,{children:"--nv"})," flag to enable NVIDIA GPU access:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"apptainer exec --nv pytorch-gpu.sif python train.py\n"})}),"\n",(0,s.jsx)(e.h3,{id:"gpu-slurm-job",children:"GPU SLURM Job"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=gpu-training\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=08:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=8\n#SBATCH --mem=32G\n#SBATCH --gres=gpu:1\n#SBATCH --partition=gpu\n\nmodule load apptainer\n\nCONTAINER=~/containers/pytorch-gpu.sif\n\n# Run with GPU access\napptainer exec --nv \\\n    --bind /data/datasets:/data:ro \\\n    --bind /scratch/$USER:/output \\\n    $CONTAINER python train.py \\\n        --data-dir /data \\\n        --output-dir /output \\\n        --epochs 100\n"})}),"\n",(0,s.jsx)(e.h3,{id:"multi-gpu-job",children:"Multi-GPU Job"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=multi-gpu\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=24:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=32\n#SBATCH --mem=128G\n#SBATCH --gres=gpu:4\n#SBATCH --partition=gpu\n\nmodule load apptainer\n\napptainer exec --nv ~/containers/pytorch-gpu.sif python -c \"\nimport torch\nprint(f'GPUs available: {torch.cuda.device_count()}')\nfor i in range(torch.cuda.device_count()):\n    print(f'  GPU {i}: {torch.cuda.get_device_name(i)}')\n\"\n\n# Run distributed training\napptainer exec --nv ~/containers/pytorch-gpu.sif \\\n    torchrun --nproc_per_node=4 train_distributed.py\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"exercise-4-gpu-container-job",children:"Exercise 4: GPU Container Job"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"mkdir -p ~/gpu-job\ncd ~/gpu-job\n"})}),"\n",(0,s.jsx)(e.p,{children:"Create a GPU test script:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'cat > gpu_test.py << \'EOF\'\n#!/usr/bin/env python3\n"""Test GPU availability."""\n\nimport torch\nimport os\n\nprint("=" * 60)\nprint("GPU Container Test")\nprint("=" * 60)\nprint(f"Job ID: {os.environ.get(\'SLURM_JOB_ID\', \'N/A\')}")\nprint(f"PyTorch: {torch.__version__}")\nprint(f"CUDA available: {torch.cuda.is_available()}")\n\nif torch.cuda.is_available():\n    print(f"CUDA version: {torch.version.cuda}")\n    print(f"GPU count: {torch.cuda.device_count()}")\n    for i in range(torch.cuda.device_count()):\n        props = torch.cuda.get_device_properties(i)\n        print(f"  GPU {i}: {props.name} ({props.total_memory/1e9:.1f} GB)")\n\n    # Quick test\n    x = torch.randn(1000, 1000, device=\'cuda\')\n    y = torch.matmul(x, x)\n    print(f"\\nGPU computation test: PASSED")\nelse:\n    print("\\nNo GPU detected. Did you use --nv flag?")\nprint("=" * 60)\nEOF\n'})}),"\n",(0,s.jsx)(e.p,{children:"Create job script:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"cat > gpu_job.sh << 'EOF'\n#!/bin/bash\n#SBATCH --job-name=gpu-test\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=00:15:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=4\n#SBATCH --mem=16G\n#SBATCH --gres=gpu:1\n#SBATCH --partition=gpu\n\nmodule load apptainer\n\napptainer exec --nv ~/containers/pytorch-gpu.sif python ~/gpu-job/gpu_test.py\nEOF\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"mpi-jobs-with-containers",children:"MPI Jobs with Containers"}),"\n",(0,s.jsx)(e.h3,{id:"running-mpi-containers",children:"Running MPI Containers"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=mpi-container\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=02:00:00\n#SBATCH --nodes=2\n#SBATCH --ntasks-per-node=16\n#SBATCH --mem=64G\n\nmodule load apptainer\nmodule load openmpi\n\n# Use host MPI to launch container processes\nmpirun -np $SLURM_NTASKS apptainer exec ~/containers/mpi-app.sif /app/parallel_sim\n"})}),"\n",(0,s.jsx)(e.h3,{id:"hybrid-mpi--openmp",children:"Hybrid MPI + OpenMP"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=hybrid-mpi\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=04:00:00\n#SBATCH --nodes=4\n#SBATCH --ntasks-per-node=4\n#SBATCH --cpus-per-task=8\n#SBATCH --mem=64G\n\nmodule load apptainer\nmodule load openmpi\n\nexport OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK\n\nmpirun -np $SLURM_NTASKS apptainer exec \\\n    --env OMP_NUM_THREADS=$OMP_NUM_THREADS \\\n    ~/containers/hybrid-app.sif /app/hybrid_code\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"array-jobs",children:"Array Jobs"}),"\n",(0,s.jsx)(e.p,{children:"Process multiple inputs efficiently:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n#SBATCH --job-name=array-container\n#SBATCH --output=logs/%x_%A_%a.out\n#SBATCH --error=logs/%x_%A_%a.err\n#SBATCH --time=01:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=4\n#SBATCH --mem=8G\n#SBATCH --array=1-100%20\n\n# %20 limits concurrent jobs to 20\n\nmodule load apptainer\n\n# Use array task ID to select input\nINPUT_FILE=/data/inputs/sample_${SLURM_ARRAY_TASK_ID}.csv\nOUTPUT_FILE=/data/outputs/result_${SLURM_ARRAY_TASK_ID}.csv\n\necho "Array task $SLURM_ARRAY_TASK_ID: Processing $INPUT_FILE"\n\napptainer exec --bind /data:/data ~/containers/analysis.sif \\\n    python process.py --input $INPUT_FILE --output $OUTPUT_FILE\n'})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,s.jsx)(e.h3,{id:"passing-variables-to-containers",children:"Passing Variables to Containers"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Using --env\napptainer exec --env MY_VAR=value container.sif printenv MY_VAR\n\n# Multiple variables\napptainer exec \\\n    --env VAR1=value1 \\\n    --env VAR2=value2 \\\n    container.sif python script.py\n\n# From host environment using APPTAINERENV_ prefix\nexport APPTAINERENV_MY_VAR="hello"\napptainer exec container.sif printenv MY_VAR\n'})}),"\n",(0,s.jsx)(e.h3,{id:"slurm-variables-in-containers",children:"SLURM Variables in Containers"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n#SBATCH ...\n\nmodule load apptainer\n\n# SLURM variables are automatically available\napptainer exec container.sif python -c "\nimport os\nprint(f\'Job ID: {os.environ.get(\\"SLURM_JOB_ID\\")}\')\nprint(f\'Node: {os.environ.get(\\"SLURM_NODEID\\")}\')\nprint(f\'CPUs: {os.environ.get(\\"SLURM_CPUS_PER_TASK\\")}\')\n"\n'})}),"\n",(0,s.jsx)(e.h3,{id:"clean-environment",children:"Clean Environment"}),"\n",(0,s.jsx)(e.p,{children:"Start with minimal environment:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Ignore host environment variables\napptainer exec --cleanenv container.sif env\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,s.jsx)(e.h3,{id:"use-local-scratch-for-io",children:"Use Local Scratch for I/O"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH ...\n\nmodule load apptainer\n\n# Copy data to fast local storage\nLOCAL_DATA=/scratch/$USER/job_$SLURM_JOB_ID\nmkdir -p $LOCAL_DATA\ncp -r /data/input/* $LOCAL_DATA/\n\n# Run with local data\napptainer exec --bind $LOCAL_DATA:/data container.sif python process.py\n\n# Copy results back\ncp -r $LOCAL_DATA/results /data/output/\nrm -rf $LOCAL_DATA\n"})}),"\n",(0,s.jsx)(e.h3,{id:"store-containers-on-fast-storage",children:"Store Containers on Fast Storage"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Store frequently-used containers on scratch\ncp ~/containers/large-container.sif /scratch/$USER/containers/\n\n# Use from scratch\napptainer exec /scratch/$USER/containers/large-container.sif python app.py\n"})}),"\n",(0,s.jsx)(e.h3,{id:"avoid-unnecessary-bind-mounts",children:"Avoid Unnecessary Bind Mounts"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Bad: Many small mounts\napptainer exec -B /d1:/d1 -B /d2:/d2 -B /d3:/d3 ...\n\n# Good: Mount parent directory\napptainer exec -B /data:/data container.sif ...\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(e.h3,{id:"common-issues-and-solutions",children:"Common Issues and Solutions"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Container not found:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Check the path\nls -la ~/containers/mycontainer.sif\n\n# Use absolute path\napptainer exec /home/user/containers/mycontainer.sif ...\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Permission denied:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Check file permissions\nls -la container.sif\n\n# Make readable\nchmod +r container.sif\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:'"Command not found" inside container:'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Check what's available\napptainer exec container.sif ls /usr/bin/\napptainer exec container.sif which python\n\n# Use full path\napptainer exec container.sif /usr/local/bin/python\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"GPU not found:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Did you forget --nv?\napptainer exec --nv container.sif nvidia-smi\n\n# Check SLURM allocation\necho $CUDA_VISIBLE_DEVICES\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Out of disk space during pull:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Set cache to scratch\nexport APPTAINER_CACHEDIR=/scratch/$USER/.apptainer\nmkdir -p $APPTAINER_CACHEDIR\napptainer pull docker://large/image\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Job runs out of memory:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Increase SLURM memory allocation\n#SBATCH --mem=64G\n\n# Or limit container memory\napptainer exec --memory 60G container.sif python memory_heavy.py\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"job-script-templates",children:"Job Script Templates"}),"\n",(0,s.jsx)(e.h3,{id:"template-standard-cpu-job",children:"Template: Standard CPU Job"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=cpu-container\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=04:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=8\n#SBATCH --mem=32G\n\nmodule load apptainer\n\nCONTAINER=~/containers/myapp.sif\nWORK_DIR=$(pwd)\n\napptainer exec \\\n    --bind $WORK_DIR:/work \\\n    --pwd /work \\\n    $CONTAINER python script.py --input data.csv --output results.csv\n"})}),"\n",(0,s.jsx)(e.h3,{id:"template-gpu-deep-learning",children:"Template: GPU Deep Learning"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=dl-training\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=24:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=16\n#SBATCH --mem=64G\n#SBATCH --gres=gpu:4\n#SBATCH --partition=gpu\n\nmodule load apptainer\n\nCONTAINER=~/containers/pytorch-gpu.sif\nDATA_DIR=/data/datasets\nOUTPUT_DIR=/scratch/$USER/training_$SLURM_JOB_ID\n\nmkdir -p $OUTPUT_DIR\n\napptainer exec --nv \\\n    --bind $DATA_DIR:/data:ro \\\n    --bind $OUTPUT_DIR:/output \\\n    $CONTAINER python train.py \\\n        --data /data \\\n        --output /output \\\n        --epochs 100 \\\n        --batch-size 64\n\n# Save final model\ncp $OUTPUT_DIR/best_model.pt /data/models/\n"})}),"\n",(0,s.jsx)(e.h3,{id:"template-bioinformatics-pipeline",children:"Template: Bioinformatics Pipeline"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n#SBATCH --job-name=bio-pipeline\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --time=12:00:00\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=16\n#SBATCH --mem=64G\n\nmodule load apptainer\n\n# Containers\nFASTQC=~/containers/fastqc.sif\nBWA=~/containers/bwa.sif\nSAMTOOLS=~/containers/samtools.sif\n\n# Paths\nREADS=/data/raw_reads\nREF=/data/reference/genome.fa\nOUT=/scratch/$USER/pipeline_$SLURM_JOB_ID\n\nmkdir -p $OUT/{qc,aligned,sorted}\n\necho "Step 1: Quality control"\napptainer exec --bind /data:/data,$OUT:/out $FASTQC \\\n    fastqc $READS/*.fastq.gz -o /out/qc -t $SLURM_CPUS_PER_TASK\n\necho "Step 2: Alignment"\napptainer exec --bind /data:/data,$OUT:/out $BWA \\\n    bwa mem -t $SLURM_CPUS_PER_TASK $REF $READS/*_R1.fastq.gz $READS/*_R2.fastq.gz \\\n    > $OUT/aligned/sample.sam\n\necho "Step 3: Sort and index"\napptainer exec --bind $OUT:/out $SAMTOOLS \\\n    samtools sort -@ $SLURM_CPUS_PER_TASK /out/aligned/sample.sam -o /out/sorted/sample.bam\n\napptainer exec --bind $OUT:/out $SAMTOOLS \\\n    samtools index /out/sorted/sample.bam\n\necho "Pipeline complete!"\nls -lh $OUT/sorted/\n'})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"quick-reference",children:"Quick Reference"}),"\n",(0,s.jsx)(e.h3,{id:"essential-commands",children:"Essential Commands"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Load module\nmodule load apptainer\n\n# Pull image\napptainer pull docker://image:tag\napptainer pull output.sif docker://image:tag\n\n# Run commands\napptainer exec image.sif command\napptainer exec --nv image.sif command          # With GPU\napptainer exec --bind /src:/dst image.sif cmd  # With bind mount\n\n# Interactive\napptainer shell image.sif\n\n# Inspect\napptainer inspect image.sif\n"})}),"\n",(0,s.jsx)(e.h3,{id:"common-flags",children:"Common Flags"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Flag"}),(0,s.jsx)(e.th,{children:"Purpose"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"--nv"})}),(0,s.jsx)(e.td,{children:"Enable NVIDIA GPU"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsxs)(e.td,{children:[(0,s.jsx)(e.code,{children:"--bind"}),", ",(0,s.jsx)(e.code,{children:"-B"})]}),(0,s.jsx)(e.td,{children:"Bind mount directories"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsxs)(e.td,{children:[(0,s.jsx)(e.code,{children:"--env"}),", ",(0,s.jsx)(e.code,{children:"-e"})]}),(0,s.jsx)(e.td,{children:"Set environment variable"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"--cleanenv"})}),(0,s.jsx)(e.td,{children:"Start with clean environment"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"--pwd"})}),(0,s.jsx)(e.td,{children:"Set working directory"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"--contain"})}),(0,s.jsx)(e.td,{children:"Minimal isolation"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"--writable-tmpfs"})}),(0,s.jsx)(e.td,{children:"Writable overlay"})]})]})]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(e.p,{children:"In this tutorial, you learned:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"How to use Apptainer to pull and run Docker images on ACE HPC"}),"\n",(0,s.jsx)(e.li,{children:"How to write SLURM job scripts for containerized workloads"}),"\n",(0,s.jsx)(e.li,{children:"How to manage data with bind mounts"}),"\n",(0,s.jsx)(e.li,{children:"How to run GPU and MPI jobs with containers"}),"\n",(0,s.jsx)(e.li,{children:"Performance optimization strategies"}),"\n",(0,s.jsx)(e.li,{children:"Troubleshooting common issues"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"additional-resources",children:"Additional Resources"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://apptainer.org/docs/user/latest/",children:"Apptainer User Guide"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"../../running-jobs/slurm-basics",children:"ACE HPC SLURM Basics"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"../../running-jobs/sample-scripts",children:"Sample SLURM Scripts"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"../../support/contact",children:"ACE HPC Support"})}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>r,x:()=>o});var a=i(6540);const s={},t=a.createContext(s);function r(n){const e=a.useContext(t);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),a.createElement(t.Provider,{value:e},n.children)}}}]);